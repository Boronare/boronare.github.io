<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<style>
canvas {
    border:1px solid #d3d3d3;
    background-color: #fff;
}
img{
	display:none;
}
</style>
</head>
<body onload="startGame()">
<img src='img/player.png' id='imgp'>
<script>

var player;
var imgp;
var blocks = [];
var keyLeft=false;
var keyRight=false;
var keyShift=false;
var keySpcBar=false;
function startGame() {
    player = new component(24, 30, 10, 120);
	imgp=document.getElementById('imgp');
	blocks.push(new component(0, 270, 480, 0));
	blocks.push(new component(0, 270, 0, 0));
	blocks.push(new component(480, 0, 0, 0));
	blocks.push(new component(480, 0, 0, 270));
	blocks.push(new component(30,30,200,240));
	blocks.push(new component(30,30,260,200));
    myGameArea.start();
}

var myGameArea = {
    canvas : document.createElement("canvas"),
    start : function() {
        this.canvas.width = 480;
        this.canvas.height = 270;
        this.context = this.canvas.getContext("2d");
        document.body.insertBefore(this.canvas, document.body.childNodes[0]);
        this.interval = setInterval(updateGameArea, 25);
    },
    clear : function() {
        this.context.clearRect(0, 0, this.canvas.width, this.canvas.height);
    }
}

function component(width, height, x, y) {
    this.width = width;
    this.height = height;
    this.speedX = 0;
    this.speedY = 0;
    this.x = x;
    this.y = y;
	this.r = ()=>{return this.x+this.width;}
	this.b = ()=>{return this.y+this.height;}
	this.ground=false;
	this.left=false;
	this.waitframe=1;
    this.pUpdate = ()=>{
		this.speedX=Math.trunc(this.speedX/1.3);
		if(keyLeft||keyRight){
			this.left=keyLeft;
			this.speedX+=keyLeft?-2:2;
			if(this.waitframe<=0){
				this.waitframe=1;
				this.offset+=24;
			}else this.waitframe--;
			if(this.offset>=144) this.offset=48;
		}else{
			this.offset=0;
		}
		this.speedY+=1;
		if(this.ground&&keySpcBar) this.speedY=-10;
		if(this.speedX!=0||this.speedY!=0){ 
			this.ground=false;
			for(i in blocks){
				o=blocks[i];
				preintersectX=this.r()>o.x&&this.x<o.r();
				preintersectY=this.b()>o.y&&this.y<o.b();
				if(preintersectY)ground=true;
				dir=(this.b()+this.speedY>o.y&&this.y<o.b())?1:this.y+this.speedY<o.b()&&this.b()>o.y?-1:0;
				if(preintersectY){
					if(this.r()+this.speedX>o.x&&this.x<o.r()) {this.speedX=o.x-this.r();}
					else if(this.x+this.speedX<o.r()&&this.r()>o.x) {this.speedX=o.r()-this.x;}
				}else if(!preintersectX){
					right=this.r()+this.speedX>o.x&&this.x<o.r()
					left=this.x+this.speedX<o.r()&&this.r()>o.x;
					if(this.b()+this.speedY>o.y&&this.y<o.b()) {
						if(right) {this.speedX=o.x-this.r(); this.speedY=o.y-this.b();this.ground=true;}
						else if(left) {this.speedX=o.r()-this.x; this.speedY=o.y-this.b();this.ground=true;}
					}
					else if(this.y+this.speedY<o.b()&&this.b()>o.y) {
						if(right) {this.speedX=o.x-this.r();  this.speedY=o.b()-this.y;}
						else if(left) {this.speedX=o.r()-this.x;  this.speedY=o.b()-this.y;}
					}
				}
				if(this.b()+this.speedY>o.y&&this.y<o.b()&&preintersectX) {this.speedY=o.y-this.b();this.ground=true;}
				else if(this.y+this.speedY<o.b()&&this.b()>o.y&&preintersectX) this.speedY=o.b()-this.y;
			}
			if(this.speedY>8) this.speedY=8;
			this.x+=this.speedX;
			this.y+=this.speedY;
			ctx=myGameArea.context;
			ctx.fillText("x:"+this.x+" y:"+this.y+" speedx:"+this.speedX+" speedy:"+this.speedY,10,10);
			ctx.fillText(this.ground,10,30);
		}
	}
	this.draw = (sw)=>{
		ctx = myGameArea.context;
		switch(sw){
		case 0:
			if(this.left){ctx.translate(144,0);ctx.scale(-1,1);}
			ctx.drawImage(imgp,this.ground?this.offset:72,0,24,30,this.left?120-this.x:this.x,this.y,24,30);
			if(this.left){ctx.translate(144,0);ctx.scale(-1,1);}
			break;
		case 1:
			ctx.fillStyle = '#555'
			ctx.fillRect(this.x, this.y, this.width, this.height);
			break;
		}
	}
	document.onkeydown=function(e){
		if(e.keyCode==37)//LeftKeyPressed
			keyLeft=true;
		else if(e.keyCode==39)//RightKeyPressed
			keyRight=true;
		else if(e.keyCode==32)//SpaceBarPressed
			keySpcBar=true;
		else if(e.keyCode==16)//Lshift pressed
			keyShift=true;
	}
	document.onkeyup=function(e){
		if(e.keyCode==37)//LeftKey released
			keyLeft=false;
		else if(e.keyCode==39)//RightKey released
			keyRight=false;
		else if(e.keyCode==32)//SpaceBar released
			keySpcBar=false;
		else if(e.keyCode==16)//Lshift released
			keyShift=false;
	}
}

function updateGameArea() {
    myGameArea.clear();
	player.pUpdate();
    for(i in blocks) blocks[i].draw(1);
    player.draw(0);
}
</script>
</body>
</html>
